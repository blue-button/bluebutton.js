<?xml version="1.0"?>
<?xml-stylesheet type="text/xsl" href="CDA.xsl"?>
<!--

    Title: US_Realm_Header_Template
    Original Filename: US_Realm_Header_Template.xml
    Version: 1.0

    Generated via BlueButton.js

-->
<ClinicalDocument xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
 xsi:schemaLocation="urn:hl7-org:v3 ../../../CDA%20R2/cda-schemas-and-samples/infrastructure/cda/CDA.xsd"
 xmlns="urn:hl7-org:v3"
 xmlns:cda="urn:hl7-org:v3"
 xmlns:sdtc="urn:hl7-org:sdtc">

<!--
********************************************************

  CDA Header

********************************************************
-->

    <realmCode code="US"/>
    <typeId root="2.16.840.1.113883.1.3" extension="POCD_HD000040"/>
    <!-- US General Header Template -->
    <templateId root="2.16.840.1.113883.10.20.22.1.1"/>
    <!-- *** Note:  The next templateId, code and title will differ depending on what type of document is being sent. *** -->
    <!-- conforms to the document specific requirements  -->
    <templateId root="2.16.840.1.113883.10.20.22.1.2"/>
    <id extension="999021" root="2.16.840.1.113883.19"/>
    <code codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" code="34133-9" displayName="Summarization of Episode Note"/>
    <title>
        <% if ("demographics" in bb) { %>
            <% if (bb.demographics.name.family) {%>
                <%= bb.demographics.name.family %> Health Summary
            <%} %>
        <%} else { %>
            Patient Health Summary
        <%} %>
    </title>
    <effectiveTime value="<%=: now | hl7Date %>"/>
    <confidentialityCode code="N" displayName="Normal" codeSystem="2.16.840.1.113883.5.25"/>
    <languageCode code="en-US"/>
    <setId extension="111199021" root="2.16.840.1.113883.19"/>
    <versionNumber value="1"/>
    <recordTarget>
        <% if ("demographics" in bb) { %>

            <patientRole>
                <id extension="12345" root="2.16.840.1.113883.19"/>
                <!-- Fake ID using HL7 example OID. -->
                <id extension="111-00-1234" root="2.16.840.1.113883.4.1"/>
                <!-- Fake Social Security Number using the actual SSN OID. -->
                <addr use="HP">
                    <!-- HP is "primary home" from codeSystem 2.16.840.1.113883.5.1119 -->
                    <streetAddressLine><%= bb.demographics.address.street %></streetAddressLine>
                    <city><%= bb.demographics.address.city %></city>
                    <state><%= bb.demographics.address.state %></state>
                    <postalCode><%= bb.demographics.address.zip %></postalCode>
                    <country><%= bb.demographics.address.country %></country>
                    <!-- US is "United States" from ISO 3166-1 Country Codes: 1.0.3166.1 -->
                </addr>
                <telecom value="tel:(781)555-1212" use="HP"/>
                <!-- HP is "primary home" from HL7 AddressUse 2.16.840.1.113883.5.1119 -->
                <patient>
                    <name use="L">
                        <!-- L is "Legal" from HL7 EntityNameUse 2.16.840.1.113883.5.45 -->
                        <prefix><%= bb.demographics.name.prefix %></prefix>
                        <% for (i in bb.demographics.name.given) { %>
                        <given><%= bb.demographics.name.given[i] %></given>
                        <% } %>
                        <family><%= bb.demographics.name.family %></family>
                    </name>
                    <administrativeGenderCode code="<%=: codes.reverseGender(bb.demographics.gender) %>" codeSystem="2.16.840.1.113883.5.1" displayName="<%= bb.demographics.gender %>"/>
                    <birthTime value="<%=: bb.demographics.dob | hl7Date %>"/>
                    <maritalStatusCode code="<%=: codes.reverseMaritalStatus(bb.demographics.marital_status) %>" displayName="<%= bb.demographics.marital_status %>" codeSystem="2.16.840.1.113883.5.2" codeSystemName="MaritalStatusCode"/>
                    <religiousAffiliationCode code="<%=: codes.reverseReligion(bb.demographics.religion) %>" displayName="<%= bb.demographics.religion %>" codeSystemName="HL7 Religious Affiliation " codeSystem="2.16.840.1.113883.1.11.19185"/>
                    <raceCode code="<%=: codes.reverseRaceEthnicity(bb.demographics.race) %>" displayName="<%= bb.demographics.race %>" codeSystem="2.16.840.1.113883.6.238" codeSystemName="Race &amp; Ethnicity - CDC"/>
                    <ethnicGroupCode code="<%=: codes.reverseRaceEthnicity(bb.demographics.ethnicity) %>" displayName="<%= bb.demographics.ethnicity %>" codeSystem="2.16.840.1.113883.6.238" codeSystemName="Race &amp; Ethnicity - CDC"/>
                    <guardian>
                        <code code="<%=: codes.reverseRole(bb.demographics.guardian.relationship) %>" displayName="<%= bb.demographics.guardian.relationship %>" codeSystem="2.16.840.1.113883.5.111" codeSystemName="HL7 Role code"/>
                        <addr use="HP">
                            <!-- HP is "primary home" from codeSystem 2.16.840.1.113883.5.1119 -->
                            <streetAddressLine><%= bb.demographics.guardian.address.street %></streetAddressLine>
                            <city><%= bb.demographics.guardian.address.city %></city>
                            <state><%= bb.demographics.guardian.address.state %></state>
                            <postalCode><%= bb.demographics.guardian.address.zip %></postalCode>
                            <country><%= bb.demographics.guardian.address.country %></country>
                            <!-- US is "United States" from ISO 3166-1 Country Codes: 1.0.3166.1 -->
                        </addr>
                        <telecom value="<%= bb.demographics.guardian.phone.home %>" use="HP"/>
                        <guardianPerson>
                            <name>
                                <% for (i in bb.demographics.guardian.name.given) { %>
                                <given><%= bb.demographics.guardian.name.given[i] %></given>
                                <% } %>
                                <family><%= bb.demographics.guardian.name.family %></family>
                            </name>
                        </guardianPerson>
                    </guardian>
                    <birthplace>
                        <place>
                            <addr>
                                <state><%= bb.demographics.birthplace.state %></state>
                                <postalCode><%= bb.demographics.birthplace.zip %></postalCode>
                                <country><%= bb.demographics.birthplace.country %></country>
                            </addr>
                        </place>
                    </birthplace>
                    <languageCommunication>
                        <languageCode code="<%= bb.demographics.language %>"/>
                        <modeCode code="RWR" displayName="Recieve Written" codeSystem="2.16.840.1.113883.5.60" codeSystemName="LanguageAbilityMode"/>
                        <preferenceInd value="true"/>
                    </languageCommunication>
                </patient>
                <providerOrganization>
                    <id root="2.16.840.1.113883.19"/>
                    <name><%= bb.demographics.provider.organization %></name>
                    <telecom use="WP" value="<%= bb.demographics.provider.phone %>"/>
                    <addr>
                        <streetAddressLine><%= bb.demographics.provider.address.street %></streetAddressLine>
                        <city><%= bb.demographics.provider.address.city %></city>
                        <state><%= bb.demographics.provider.address.state %></state>
                        <postalCode><%= bb.demographics.provider.address.zip %></postalCode>
                        <country><%= bb.demographics.provider.address.country %></country>
                    </addr>
                </providerOrganization>
            </patientRole>

        <%} %>

    </recordTarget>
    
    <% if ("document" in bb) { %>
        <author>
            <time value="<%=: now | hl7Date %>"/>
            <assignedAuthor>
                <id extension="KP00017" root="2.16.840.1.113883.19.5"/>
                <addr>
                    <% for (var i=0; i<bb.document.author.address.street.length; i++) { %>
                        <streetAddressLine><%= bb.document.author.address.street[i] %></streetAddressLine>
                    <%} %>
                    <city><%= bb.document.author.address.city %></city>
                    <state><%= bb.document.author.address.state %></state>
                    <postalCode><%= bb.document.author.address.zip %></postalCode>
                </addr>
                <telecom use="WP" value="<%= bb.document.author.phone.work %>"/>
                <assignedPerson>
                    <name>
                        <% for (var i=0; i<bb.document.author.name.given.length; i++) { %>
                            <given><%= bb.document.author.name.given[i] %></given>
                        <%} %>
                        <family><%= bb.document.author.name.family %></family>
                    </name>
                </assignedPerson>
            </assignedAuthor>
        </author>
        <custodian>
            <assignedCustodian>
                <representedCustodianOrganization>
                    <id extension="99999999" root="2.16.840.1.113883.4.6"/>
                    <name><%= bb.document.author.name.family %></name>
                    <telecom use="WP" value="<%= bb.document.author.phone.work %>"/>
                    <addr>
                        <% for (var i=0; i<bb.document.author.address.street.length; i++) { %>
                            <streetAddressLine><%= bb.document.author.address.street[i] %></streetAddressLine>
                        <%} %>
                        <city><%= bb.document.author.address.city %></city>
                        <state><%= bb.document.author.address.state %></state>
                        <postalCode><%= bb.document.author.address.zip %></postalCode>
                    </addr>
                </representedCustodianOrganization>
            </assignedCustodian>
        </custodian>
    <%} %>

    <!-- ********************************************************

     CDA Body

     ******************************************************** -->
    <component>
        <structuredBody>
            <!-- *********************** -->

            <% if ("allergies" in bb) { %>

                <!--
                ********************************************************

                Allergies, Adverse Reactions, Alerts

                ********************************************************
                -->
                    <component>
                        <section>
                            <templateId root="2.16.840.1.113883.10.20.22.2.6.1"/>
                            <!-- Alerts section template -->
                            <code code="48765-2" codeSystem="2.16.840.1.113883.6.1"/>
                            <title>Allergies, Adverse Reactions, Alerts</title>

                            <% for (var i=0; i<bb.allergies.length; i++) { %>

                            <entry typeCode="DRIV">
                                <act classCode="ACT" moodCode="EVN">
                                    <templateId root="2.16.840.1.113883.10.20.22.4.30"/>
                                    <!-- ** Allergy problem act ** -->
                                    <id root="36e3e930-7b14-11db-9fe1-0800200c9a66"/>
                                    <code code="48765-2" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Allergies, adverse reactions, alerts"/>
                                    <statusCode code="<%= bb.allergies[i].status %>"/>
                                    <effectiveTime value="<%=: bb.allergies[i].date_range.start | hl7Date %>" >
                                        <low value="<%=: bb.allergies[i].date_range.start | hl7Date %>"/>
                                        <high value="<%=: bb.allergies[i].date_range.end | hl7Date %>"/>
                                    </effectiveTime>
                                    <entryRelationship typeCode="SUBJ">
                                        <observation classCode="OBS" moodCode="EVN">
                                            <!-- allergy observation template -->
                                            <templateId root="2.16.840.1.113883.10.20.22.4.7"/>
                                            <id root="4adc1020-7b14-11db-9fe1-0800200c9a66"/>
                                            <code <%-: bb.allergies[i] | hl7Code %> />
                                            <statusCode code="completed"/>
                                            <effectiveTime>
                                                <low value="<%=: bb.allergies[i].date_range.start | hl7Date %>"/>
                                            </effectiveTime>
                                            <value xsi:type="CD" <%-: bb.allergies[i].reaction_type | hl7Code %> >
                                                <originalText>
                                                    <%= bb.allergies[i].name %>
                                                    <reference value="#reaction<%= i %>"/>
                                                </originalText>
                                            </value>
                                            <participant typeCode="CSM">
                                                <participantRole classCode="MANU">
                                                    <playingEntity classCode="MMAT">
                                                        <code <%-: bb.allergies[i].allergen | hl7Code %> >
                                                            <originalText>
                                                                <reference value="#reaction<%= i %>"/>
                                                            </originalText>
                                                        </code>
                                                        <name>Penicillin</name>
                                                    </playingEntity>
                                                </participantRole>
                                            </participant>
                                            <entryRelationship typeCode="SUBJ">
                                                <observation classCode="OBS" moodCode="EVN">
                                                    <templateId root="2.16.840.1.113883.10.20.22.4.28"/>
                                                    <!-- Alert status observation template -->
                                                    <code code="33999-4" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Status"/>
                                                    <statusCode code="completed"/>
                                                    <value xsi:type="CE" code="55561003" codeSystem="2.16.840.1.113883.6.96" displayName="<%= bb.allergies[i].status %>"/>
                                                </observation>
                                            </entryRelationship>
                                            <entryRelationship typeCode="MFST">
                                                <observation classCode="OBS" moodCode="EVN">
                                                    <templateId root="2.16.840.1.113883.10.20.22.4.9"/>
                                                    <!-- Reaction observation template -->
                                                    <id root="4adc1020-7b14-11db-9fe1-0800200c9a64"/>
                                                    <code nullFlavor="NA"/>
                                                    <text>
                                                        <reference value="#reaction<%= i %>"/>
                                                    </text>
                                                    <statusCode code="completed"/>
                                                    <effectiveTime>
                                                        <low value="<%=: bb.allergies[i].date_range.start | hl7Date %>"/>
                                                    </effectiveTime>
                                                    <value xsi:type="CD" <%-: bb.allergies[i].reaction | hl7Code %> />
                                                </observation>
                                            </entryRelationship>
                                            <entryRelationship typeCode="SUBJ">
                                                <observation classCode="OBS" moodCode="EVN">
                                                    <templateId root="2.16.840.1.113883.10.20.22.4.8"/>
                                                    <!-- ** Severity observation template ** -->
                                                    <code code="SEV" displayName="Severity Observation" codeSystem="2.16.840.1.113883.5.4" codeSystemName="ActCode"/>
                                                    <text>
                                                        <reference value="#severity<%= i %>"/>
                                                    </text>
                                                    <statusCode code="completed"/>
                                                    <value xsi:type="CD" code="" displayName="<%= bb.allergies[i].severity %>" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED CT"/>
                                                </observation>
                                            </entryRelationship>
                                        </observation>
                                    </entryRelationship>
                                </act>
                            </entry>

                            <% } %>

                        </section>
                    </component>

            <%} %>


            <% if (("medications" in bb)) { %>

                <!--
                ********************************************************

                MEDICATIONS

                ********************************************************
                -->
                    <component>
                        <section>
                            <templateId root="2.16.840.1.113883.10.20.22.2.1.1"/>
                            <code code="10160-0" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="HISTORY OF MEDICATION USE"/>
                            <title>Medications</title>

                            <% for (var i=0; i<bb.medications.length; i++) { %>

                            <entry typeCode="DRIV">
                                <substanceAdministration classCode="SBADM" moodCode="EVN">
                                    <templateId root="2.16.840.1.113883.10.20.22.4.16"/>
                                    <!-- ** MEDICATION ACTIVITY -->
                                    <id root="cdbd33f0-6cde-11db-9fe1-0800200c9a66"/>
                                    <text>
                                    </text>
                                    <statusCode code="completed"/>
                                    <effectiveTime xsi:type="IVL_TS">
                                        <low value="<%=: bb.medications[i].date_range.start | hl7Date %>"/>
                                        <high value="<%=: bb.medications[i].date_range.end | hl7Date %>"/>
                                    </effectiveTime>
                                    <routeCode <%-: bb.medications[i].route | hl7Code %> />
                                    <doseQuantity value="<%= bb.medications[i].dose_quantity.value %>" unit="<%= bb.medications[i].dose_quantity.unit %>"/>
                                    <rateQuantity value="<%= bb.medications[i].rate_quantity.value %>" unit="<%= bb.medications[i].rate_quantity.unit %>"/>
                                    <maxDoseQuantity nullFlavor="UNK">
                                        <numerator nullFlavor="UNK"/>
                                        <denominator nullFlavor="UNK"/>
                                    </maxDoseQuantity>
                                    <administrationUnitCode <%-: bb.medications[i].administration | hl7Code %> />
                                    <consumable>
                                        <manufacturedProduct>
                                            <templateId root="2.16.840.1.113883.10.20.22.4.23"/>
                                            <id/>
                                            <manufacturedMaterial>
                                                <code <%-: bb.medications[i].product | hl7Code %> >
                                                    <translation <%-: bb.medications[i].product.translation | hl7Code %>/>
                                                </code>
                                            </manufacturedMaterial>
                                            <manufacturerOrganization/>
                                        </manufacturedProduct>
                                    </consumable>
                                    <participant typeCode="CSM">
                                        <participantRole classCode="MANU">
                                            <templateId root="2.16.840.1.113883.10.20.22.4.24"/>
                                            <code <%-: bb.medications[i].vehicle | hl7Code %>/>
                                        </participantRole>
                                    </participant>
                                    <entryRelationship typeCode="RSON">
                                        <observation classCode="COND" moodCode="EVN">
                                            <templateId root="2.16.840.1.113883.10.20.22.4.19"/>
                                            <id root="db734647-fc99-424c-a864-7e3cda82e703" extension="45665"/>
                                            <code code="404684003" displayName="Finding" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED CT"/>
                                            <statusCode code="completed"/>
                                            <value xsi:type="CE" <%-: bb.medications[i].reason | hl7Code %>/>
                                        </observation>
                                    </entryRelationship>
                                    <precondition typeCode="PRCN">
                                        <templateId root="2.16.840.1.113883.10.20.22.4.25"/>
                                        <criterion>
                                            <code code="ASSERTION" codeSystem="2.16.840.1.113883.5.4"/>
                                            <value xsi:type="CE" <%-: bb.medications[i].precondition | hl7Code %>/>
                                        </criterion>
                                    </precondition>
                                </substanceAdministration>
                            </entry>

                            <% } %>


                        </section>
                    </component>

            <% } %>
            

            <% if (("problems" in bb)) { %>

                <!--
                ********************************************************

                PROBLEM LIST

                ********************************************************
                -->
                    <component>
                        <section>
                            <templateId root="2.16.840.1.113883.10.20.22.2.5.1"/>
                            <code code="11450-4" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="PROBLEM LIST"/>
                            <title>Problems</title>
                            <text>
                            </text>

                            <% for (var i=0; i<bb.problems.length; i++) { %>

                            <entry typeCode="DRIV">
                                <act classCode="ACT" moodCode="EVN">
                                    <!-- Problem act template -->
                                    <templateId root="2.16.840.1.113883.10.20.22.4.3"/>
                                    <id root="ec8a6ff8-ed4b-4f7e-82c3-e98e58b45de7"/>
                                    <code nullFlavor="NA"/>
                                    <statusCode code="completed"/>
                                    <effectiveTime>
                                        <low value="<%=: bb.problems[i].date_range.start | hl7Date %>"/>
                                        <high value="<%=: bb.problems[i].date_range.end | hl7Date %>"/>
                                    </effectiveTime>
                                    <entryRelationship typeCode="SUBJ">
                                        <observation classCode="OBS" moodCode="EVN">
                                            <!-- Problem observation template -->
                                            <templateId root="2.16.840.1.113883.10.20.22.4.4"/>
                                            <id root="ab1791b0-5c71-11db-b0de-0800200c9a66"/>
                                            <code code="409586006" codeSystem="2.16.840.1.113883.6.96" displayName="Complaint"/>
                                            <statusCode code="completed"/>
                                            <effectiveTime>
                                                <low value="<%=: bb.problems[i].date_range.start | hl7Date %>"/>
                                            </effectiveTime>
                                            <value xsi:type="CD" <%-: bb.problems[i] | hl7Code %> />
                                            <entryRelationship typeCode="REFR">
                                                <observation classCode="OBS" moodCode="EVN">
                                                    <!-- Problem status observation template -->
                                                    <templateId root="2.16.840.1.113883.10.20.22.4.6"/>
                                                    <code code="33999-4" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="Status"/>
                                                    <statusCode code="completed"/>
                                                    <value xsi:type="CD" code="55561003" codeSystem="2.16.840.1.113883.6.96" displayName="<%= bb.problems[i].status %>" codeSystemName="SNOMED CT"/>
                                                </observation>
                                            </entryRelationship>
                                            <entryRelationship typeCode="SUBJ" inversionInd="true">
                                                <observation classCode="OBS" moodCode="EVN">
                                                    <templateId root="2.16.840.1.113883.10.20.22.4.31"/>
                                                    <!--    Age observation template   -->
                                                    <code code="397659008" codeSystem="2.16.840.1.113883.6.96" displayName="Age"/>
                                                    <statusCode code="completed"/>
                                                    <value xsi:type="PQ" value="<%= bb.problems[i].age %>" unit="a"/>
                                                </observation>
                                            </entryRelationship>
                                        </observation>
                                    </entryRelationship>
                                </act>
                            </entry>

                            <% } %>

                        </section>
                    </component>

            <% } %>
            

            <% if (("procedures" in bb)) { %>

                <!--
                ********************************************************

                PROCEDURES

                ********************************************************
                -->
                    <component>
                        <section>
                            <templateId root="2.16.840.1.113883.10.20.22.2.7.1"/>
                            <!-- Procedures section template -->
                            <code code="47519-4" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="PROCEDURES"/>
                            <title>Procedures</title>
                            <text>
                            </text>

                            <% for (var i=0; i<bb.procedures.length; i++) { %>

                            <entry typeCode="DRIV">
                                <procedure classCode="PROC" moodCode="EVN">
                                    <templateId root="2.16.840.1.113883.10.20.22.4.14"/>
                                    <!-- ***** Procedure  Activity Procedure Template ***** -->
                                    <id root="d68b7e32-7810-4f5b-9cc2-acd54b0fd85d"/>
                                    <code <%-: bb.procedures[i] | hl7Code %> >
                                        <originalText>
                                            <reference value="#Proc<%=i%>"/>
                                        </originalText>
                                    </code>
                                    <statusCode code="completed"/>
                                    <effectiveTime value="<%=: bb.procedures[i].date | hl7Date %>"/>
                                    <methodCode nullFlavor="UNK"/>
                                    <specimen typeCode="SPC">
                                        <specimenRole classCode="SPEC">
                                            <id root="c2ee9ee9-ae31-4628-a919-fec1cbb58683"/>
                                            <specimenPlayingEntity>
                                                <code <%-: bb.procedures[i].specimen | hl7Code %> />
                                            </specimenPlayingEntity>
                                        </specimenRole>
                                    </specimen>
                                    <performer>
                                        <assignedEntity>
                                            <id root="c2ee9ee9-ae31-4628-a919-fec1cbb58687"/>
                                            <addr>
                                                <streetAddressLine><%=bb.procedures[i].performer.street %></streetAddressLine>
                                                <city><%=bb.procedures[i].performer.city %></city>
                                                <state><%=bb.procedures[i].performer.state %></state>
                                                <postalCode><%=bb.procedures[i].performer.zip %></postalCode>
                                                <country><%=bb.procedures[i].performer.country %></country>
                                            </addr>
                                            <telecom use="WP" value="<%=bb.procedures[i].performer.phone %>"/>
                                            <representedOrganization>
                                                <id root="c2ee9ee9-ae31-4628-a919-fec1cbb58686"/>
                                                <name><%=bb.procedures[i].performer.organization %></name>
                                                <telecom use="WP" value="<%=bb.procedures[i].performer.phone %>"/>
                                                <addr>
                                                    <streetAddressLine><%=bb.procedures[i].performer.street %></streetAddressLine>
                                                    <city><%=bb.procedures[i].performer.city %></city>
                                                    <state><%=bb.procedures[i].performer.state %></state>
                                                    <postalCode><%=bb.procedures[i].performer.zip %></postalCode>
                                                    <country><%=bb.procedures[i].performer.country %></country>
                                                </addr>
                                            </representedOrganization>
                                        </assignedEntity>
                                    </performer>
                                    <participant typeCode="LOC">
                                        <participantRole classCode="MANU">
                                            <templateId root="2.16.840.1.113883.10.20.22.4.37"/>
                                            <!--   Product instance template   -->
                                            <id root="eb936010-7b17-11db-9fe1-0800200c9a68"/>
                                            <playingDevice>
                                                <code <%-: bb.procedures[i].device | hl7Code %> />
                                            </playingDevice>
                                            <scopingEntity>
                                                <id root="eb936010-7b17-11db-9fe1-0800200c9b65"/>
                                            </scopingEntity>
                                        </participantRole>
                                    </participant>
                                </procedure>
                            </entry>

                            <% } %>

                        </section>
                    </component>

            <% } %>
            

            <% if (("labs" in bb)) { %>

                <!--
                ********************************************************

                RESULTS

                ********************************************************
                -->
                    <component>
                        <section>
                            <templateId root="2.16.840.1.113883.10.20.22.2.3.1"/>
                            <code code="30954-2" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="RESULTS"/>
                            <title>Results</title>
                            <text>

                            </text>

                            <% for (var i=0; i<bb.labs.length; i++) { %>


                            <entry typeCode="DRIV">
                                <organizer classCode="BATTERY" moodCode="EVN">
                                    <!-- Result organizer template -->
                                    <templateId root="2.16.840.1.113883.10.20.22.4.1"/>
                                    <id root="7d5a02b0-67a4-11db-bd13-0800200c9a66"/>
                                    <code code="<%=bb.labs[i].code %>" displayName="<%=bb.labs[i].name %>" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED CT"/>
                                    <statusCode code="completed"/>

                                    <% for (var j=0; j<bb.labs[i].results.length; j++) { %>


                                    <component>
                                        <observation classCode="OBS" moodCode="EVN">
                                            <!-- Result observation template -->
                                            <templateId root="2.16.840.1.113883.10.20.22.4.2"/>
                                            <id root="107c2dc0-67a5-11db-bd13-0800200c9a66"/>
                                            <code <%-: bb.labs[i].results[j] | hl7Code %> >
                                                <originalText>
                                                    <reference value="#result<%=j%>"/>
                                                </originalText>
                                            </code>
                                            <statusCode code="completed"/>
                                            <effectiveTime value="<%=: bb.labs[i].results[j].date | hl7Date %>"/>
                                            <value xsi:type="PQ" value="<%=bb.labs[i].results[j].value%>" unit="<%=bb.labs[i].results[j].unit%>"/>
                                            <interpretationCode code="N" codeSystem="2.16.840.1.113883.5.83"/>
                                            <methodCode/>
                                            <targetSiteCode/>
                                            <author>
                                                <time/>
                                                <assignedAuthor>
                                                    <id/>
                                                </assignedAuthor>
                                            </author>
                                            <referenceRange>
                                                <observationRange>
                                                    <text></text>
                                                </observationRange>
                                            </referenceRange>
                                        </observation>
                                    </component>


                                    <% } %>

                                </organizer>
                            </entry>

                            <% } %>

                        </section>
                    </component>

            <% } %>

            
            <% if (("encounters" in bb)) { %>

                <!--
                ********************************************************

                ENCOUNTERS

                ********************************************************
                -->
                    <component>
                        <section>
                            <templateId root="2.16.840.1.113883.10.20.22.2.22.1"/>
                            <!-- Encounters Section - required entries -->
                            <code code="46240-8" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="History of encounters"/>
                            <title>Encounters</title>
                            <text>

                            </text>

                            <% for (var i=0; i<bb.encounters.length; i++) { %>

                            <entry typeCode="DRIV">
                                <encounter classCode="ENC" moodCode="EVN">
                                    <templateId root="2.16.840.1.113883.10.20.22.4.49"/>
                                    <!-- Encounter Activities -->
                                    <!--  ********  Encounter activity template   ******** -->
                                    <id root="2a620155-9d11-439e-92b3-5d9815ff4de8"/>
                                    <code <%-: bb.encounters[i] | hl7Code %> codeSystemVersion="<%= bb.encounters[i].code_system_version%>">
                                        <originalText><reference value="#Encounter<%=1%>"/>
                                        </originalText>
                                        <translation <%-: bb.encounters[i].translation | hl7Code %> />
                                    </code>
                                    <effectiveTime value="<%=: bb.encounters[i].date | hl7Date %>"/>
                                    <performer>
                                        <assignedEntity>
                                            <id/>
                                            <code <%-: bb.encounters[i].performer | hl7Code %> />
                                        </assignedEntity>
                                    </performer>
                                    <participant typeCode="LOC">
                                        <participantRole classCode="SDLOC">
                                            <templateId root="2.16.840.1.113883.10.20.22.4.32"/>
                                            <!-- Service Delivery Location template -->
                                            <code code="GACH" codeSystem="2.16.840.1.113883.5.111" codeSystemName="HL7 RoleCode" displayName="<%= bb.encounters[i].location.organization%>"/>
                                            <addr>
                                                <streetAddressLine><%= bb.encounters[i].location.street%></streetAddressLine>
                                                <city><%= bb.encounters[i].location.city%></city>
                                                <state><%= bb.encounters[i].location.state%></state>
                                                <postalCode><%= bb.encounters[i].location.zip%></postalCode>
                                                <country><%= bb.encounters[i].location.streer%></country>
                                            </addr>
                                            <telecom nullFlavor="UNK"/>
                                        </participantRole>
                                    </participant>
                                    <entryRelationship typeCode="RSON">
                                        <observation classCode="COND" moodCode="EVN">
                                            <templateId root="2.16.840.1.113883.10.20.22.4.19"/>
                                            <id root="db734647-fc99-424c-a864-7e3cda82e703" extension="45665"/>
                                            <code code="404684003" displayName="Finding" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED CT"/>
                                            <statusCode code="completed"/>
                                            <value xsi:type="CE" <%-: bb.encounters[i].finding | hl7Code %> />
                                        </observation>
                                    </entryRelationship>
                                </encounter>
                            </entry>

                            <% } %>
                        </section>
                    </component>

            <% } %>
            

            <% if (("immunizations" in bb)) { %>

                <!--
                ********************************************************

                IMMUNIZATIONS

                ********************************************************
                -->
                    <component>
                        <section>
                            <templateId root="2.16.840.1.113883.10.20.22.2.2.1"/>
                            <!--  ********  Immunizations section template   ******** -->
                            <code code="11369-6" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="History of immunizations"/>
                            <title>Immunizations</title>
                            <text>

                            </text>

                            <% for (var i=0; i<bb.immunizations.length; i++) { %>

                            <entry typeCode="DRIV">
                                <substanceAdministration classCode="SBADM" moodCode="EVN" negationInd="false">
                                    <templateId root="2.16.840.1.113883.10.20.22.4.52"/>
                                    <!--  ********   Immunization activity template    ******** -->
                                    <id root="e6f1ba43-c0ed-4b9b-9f12-f435d8ad8f92"/>
                                    <text>
                                        <reference value="#immun<%=i%>"/>
                                    </text>
                                    <statusCode code="completed"/>
                                    <effectiveTime xsi:type="IVL_TS" value="<%=: bb.immunizations[i].date | hl7Date %>"/>
                                    <routeCode <%-: bb.immunizations[i].route | hl7Code %> />
                                    <doseQuantity nullFlavor="UNK"/>
                                    <consumable>
                                        <manufacturedProduct>
                                            <templateId root="2.16.840.1.113883.10.20.22.4.54"/>
                                            <!--  ********   Immunization Medication Information    ******** -->
                                            <manufacturedMaterial>
                                                <code <%-: bb.immunizations[i].product | hl7Code %> >
                                                    <originalText>Influenza virus vaccine</originalText>
                                                    <translation <%-: bb.immunizations[i].product.translation | hl7Code %> />
                                                </code>
                                            </manufacturedMaterial>
                                        </manufacturedProduct>
                                    </consumable>
                                    <entryRelationship typeCode="SUBJ">
                                        <act classCode="ACT" moodCode="INT">
                                            <templateId root="2.16.840.1.113883.10.20.22.4.20"/>
                                            <!-- ** Instructions Template ** -->
                                            <code <%-: bb.immunizations[i].education_type | hl7Code %> />
                                            <text><%= bb.immunizations[i].instructions%></text>
                                            <statusCode code="completed"/>
                                        </act>
                                    </entryRelationship>
                                </substanceAdministration>
                            </entry>

                            <% } %>

                        </section>
                    </component>

            <% } %>
            

            <% if (("vitals" in bb)) { %>

                <!--
                ********************************************************

                VITAL SIGNS

                ********************************************************
                -->
                    <component>
                        <section>
                            <templateId root="2.16.840.1.113883.10.20.22.2.4.1"/>
                            <code code="8716-3" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="VITAL SIGNS"/>
                            <title>Vital Signs</title>
                            <text>
                            </text>


                            <% for (var i=0; i<bb.vitals.length; i++) { %>


                            <entry typeCode="DRIV">
                                <organizer classCode="CLUSTER" moodCode="EVN">
                                    <templateId root="2.16.840.1.113883.10.20.22.4.26"/>
                                    <!-- Vital signs organizer template -->
                                    <id root="c6f88320-67ad-11db-bd13-0800200c9a66"/>
                                    <code code="46680005" codeSystem="2.16.840.1.113883.6.96" codeSystemName="SNOMED -CT" displayName="Vital signs"/>
                                    <statusCode code="completed"/>
                                    <effectiveTime value="<%=: bb.vitals[i].date | hl7Date %>"/>

                                    <% for (var j=0; j<bb.vitals[i].results.length;j++) {%>
                                    <component>
                                        <observation classCode="OBS" moodCode="EVN">
                                            <templateId root="2.16.840.1.113883.10.20.22.4.27"/>
                                            <!-- Vital Sign Observation template -->
                                            <id root="c6f88321-67ad-11db-bd13-0800200c9a66"/>
                                            <code code="<%=bb.vitals[i].results[j].code%>" codeSystem="2.16.840.1.113883.6.1" codeSystemName="LOINC" displayName="<%=bb.vitals[i].results[j].name%>"/>
                                            <statusCode code="completed"/>
                                            <effectiveTime value="<%=: bb.vitals[i].date | hl7Date %>"/>
                                            <value xsi:type="PQ" value="<%=bb.vitals[i].results[j].value%>" unit="<%=bb.vitals[i].results[j].unit%>"/>
                                            <interpretationCode code="N" codeSystem="2.16.840.1.113883.5.83"/>
                                        </observation>
                                    </component>
                                    <% } %>
                                    
                                </organizer>
                            </entry>


                            <% } %>
                        </section>
                    </component>

            <% } %>

        </structuredBody>
    </component>

<!--
**Required Sections

Allergies
Medications
Problem List
Procedures
Results

**Optional Sections

Advance Directives
Encounters
Family History
Functional Status
Immunizations
Medical Equipment
Payers
Plan of Care
Social History
Vital Signs
-->

</ClinicalDocument>